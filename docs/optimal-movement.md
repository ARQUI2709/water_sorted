## Recomendación de implementación (A* con costo unitario por vertido)

**Representación**

* `State`: arreglo de botellas, cada botella es un arreglo (stack) de colores, bottom→top.
* Un `move` es `{ from: i, to: j, amount: k, color: c }`, pero para el costo solo importa que sea 1 movimiento.

**Regla de vertido (1 movimiento)**

* Solo se puede verter de `from` a `to` si:
  * `from` no está vacía.
  * `to` no está llena.
  * `to` está vacía **o** su color superior coincide con el color superior de `from`.
* `amount` (cuántos segmentos se mueven en ese vertido) se calcula como:
  * `k = min( topRunLength(from), freeSpace(to) )`
  * donde `topRunLength(from)` = cantidad de segmentos consecutivos del mismo color en el tope de `from`.
* Todo ese vertido cuenta como **1** movimiento (costo 1), aunque `k > 1`.

**Objetivo**

* `isSolved(state)` devuelve true si cada botella está vacía o contiene un solo color (todas sus celdas iguales) y está completa.

---

## Algoritmo para obtener movimientos óptimos

## Opción 1 (exacto, simple pero pesado): BFS

* Úsalo si `N` es pequeño o si vas a precomputar offline.
* En un grafo no ponderado (cada movimiento cuesta 1), BFS encuentra la solución con menos movimientos.[](https://stackoverflow.com/questions/14784753/shortest-path-dfs-bfs-or-both)

## Opción 2 (recomendado): A*

* Implementa A* con:
  * `g(s)` = movimientos realizados hasta `s`.
  * `h(s)` = heurística (estimación del mínimo de movimientos restantes).
  * `f(s) = g(s) + h(s)` prioridad en cola.
* A* encuentra el camino óptimo si `h` es admisible (no sobreestima).

---

## Pseudocódigo TypeScript (estructura)

<pre class="not-prose w-full rounded font-mono text-sm font-extralight"><div class="codeWrapper text-light selection:text-super selection:bg-super/10 my-md relative flex flex-col rounded-lg font-mono text-sm font-medium bg-subtler"><div class="translate-y-xs -translate-x-xs bottom-xl mb-xl flex h-0 items-start justify-end sm:sticky sm:top-xs"><div class="overflow-hidden rounded-full border-subtlest ring-subtlest divide-subtlest bg-base"><div class="border-subtlest ring-subtlest divide-subtlest bg-subtler"></div></div></div><div class="-mt-xl"><div><div data-testid="code-language-indicator" class="text-quiet bg-subtle py-xs px-sm inline-block rounded-br rounded-tl-lg text-xs font-thin">ts</div></div><div><span><code><span><span class="token token">type</span><span></span><span class="token token">Color</span><span></span><span class="token token operator">=</span><span></span><span class="token token">number</span><span class="token token punctuation">;</span><span></span><span class="token token">// o string</span><span>
</span></span><span><span></span><span class="token token">type</span><span></span><span class="token token">Bottle</span><span></span><span class="token token operator">=</span><span> Color</span><span class="token token punctuation">[</span><span class="token token punctuation">]</span><span class="token token punctuation">;</span><span></span><span class="token token">// bottom..top</span><span>
</span></span><span><span></span><span class="token token">type</span><span></span><span class="token token">State</span><span></span><span class="token token operator">=</span><span> Bottle</span><span class="token token punctuation">[</span><span class="token token punctuation">]</span><span class="token token punctuation">;</span><span>
</span></span><span>
</span><span><span></span><span class="token token">type</span><span></span><span class="token token">Move</span><span></span><span class="token token operator">=</span><span></span><span class="token token punctuation">{</span><span> from</span><span class="token token operator">:</span><span></span><span class="token token">number</span><span class="token token punctuation">;</span><span> to</span><span class="token token operator">:</span><span></span><span class="token token">number</span><span class="token token punctuation">;</span><span> amount</span><span class="token token operator">:</span><span></span><span class="token token">number</span><span class="token token punctuation">;</span><span> color</span><span class="token token operator">:</span><span> Color </span><span class="token token punctuation">}</span><span class="token token punctuation">;</span><span>
</span></span><span>
</span><span><span></span><span class="token token">function</span><span></span><span class="token token">topColor</span><span class="token token punctuation">(</span><span>b</span><span class="token token operator">:</span><span> Bottle</span><span class="token token punctuation">)</span><span class="token token operator">:</span><span> Color </span><span class="token token operator">|</span><span></span><span class="token token">null</span><span></span><span class="token token punctuation">{</span><span>
</span></span><span><span></span><span class="token token">return</span><span> b</span><span class="token token punctuation">.</span><span>length </span><span class="token token operator">?</span><span> b</span><span class="token token punctuation">[</span><span>b</span><span class="token token punctuation">.</span><span>length </span><span class="token token operator">-</span><span></span><span class="token token">1</span><span class="token token punctuation">]</span><span></span><span class="token token operator">:</span><span></span><span class="token token">null</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token punctuation">}</span><span>
</span></span><span>
</span><span><span></span><span class="token token">function</span><span></span><span class="token token">freeSpace</span><span class="token token punctuation">(</span><span>b</span><span class="token token operator">:</span><span> Bottle</span><span class="token token punctuation">,</span><span></span><span class="token token constant">CAP</span><span class="token token operator">:</span><span></span><span class="token token">number</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span></span><span><span></span><span class="token token">return</span><span></span><span class="token token constant">CAP</span><span></span><span class="token token operator">-</span><span> b</span><span class="token token punctuation">.</span><span>length</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token punctuation">}</span><span>
</span></span><span>
</span><span><span></span><span class="token token">function</span><span></span><span class="token token">topRunLength</span><span class="token token punctuation">(</span><span>b</span><span class="token token operator">:</span><span> Bottle</span><span class="token token punctuation">)</span><span class="token token operator">:</span><span></span><span class="token token">number</span><span></span><span class="token token punctuation">{</span><span>
</span></span><span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span class="token token operator">!</span><span>b</span><span class="token token punctuation">.</span><span>length</span><span class="token token punctuation">)</span><span></span><span class="token token">return</span><span></span><span class="token token">0</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token">const</span><span> c </span><span class="token token operator">=</span><span> b</span><span class="token token punctuation">[</span><span>b</span><span class="token token punctuation">.</span><span>length </span><span class="token token operator">-</span><span></span><span class="token token">1</span><span class="token token punctuation">]</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token">let</span><span> k </span><span class="token token operator">=</span><span></span><span class="token token">0</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token">for</span><span></span><span class="token token punctuation">(</span><span class="token token">let</span><span> i </span><span class="token token operator">=</span><span> b</span><span class="token token punctuation">.</span><span>length </span><span class="token token operator">-</span><span></span><span class="token token">1</span><span class="token token punctuation">;</span><span> i </span><span class="token token operator">>=</span><span></span><span class="token token">0</span><span class="token token punctuation">;</span><span> i</span><span class="token token operator">--</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span></span><span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span>b</span><span class="token token punctuation">[</span><span>i</span><span class="token token punctuation">]</span><span></span><span class="token token operator">!==</span><span> c</span><span class="token token punctuation">)</span><span></span><span class="token token">break</span><span class="token token punctuation">;</span><span>
</span></span><span><span>    k</span><span class="token token operator">++</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token punctuation">}</span><span>
</span></span><span><span></span><span class="token token">return</span><span> k</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token punctuation">}</span><span>
</span></span><span>
</span><span><span></span><span class="token token">function</span><span></span><span class="token token">canPour</span><span class="token token punctuation">(</span><span>from</span><span class="token token operator">:</span><span> Bottle</span><span class="token token punctuation">,</span><span> to</span><span class="token token operator">:</span><span> Bottle</span><span class="token token punctuation">,</span><span></span><span class="token token constant">CAP</span><span class="token token operator">:</span><span></span><span class="token token">number</span><span class="token token punctuation">)</span><span class="token token operator">:</span><span></span><span class="token token">boolean</span><span></span><span class="token token punctuation">{</span><span>
</span></span><span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span>from</span><span class="token token punctuation">.</span><span>length </span><span class="token token operator">===</span><span></span><span class="token token">0</span><span class="token token punctuation">)</span><span></span><span class="token token">return</span><span></span><span class="token token boolean">false</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span>to</span><span class="token token punctuation">.</span><span>length </span><span class="token token operator">===</span><span></span><span class="token token constant">CAP</span><span class="token token punctuation">)</span><span></span><span class="token token">return</span><span></span><span class="token token boolean">false</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token">const</span><span> cf </span><span class="token token operator">=</span><span></span><span class="token token">topColor</span><span class="token token punctuation">(</span><span>from</span><span class="token token punctuation">)</span><span class="token token operator">!</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token">const</span><span> ct </span><span class="token token operator">=</span><span></span><span class="token token">topColor</span><span class="token token punctuation">(</span><span>to</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token">return</span><span> ct </span><span class="token token operator">===</span><span></span><span class="token token">null</span><span></span><span class="token token operator">||</span><span> ct </span><span class="token token operator">===</span><span> cf</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token punctuation">}</span><span>
</span></span><span>
</span><span><span></span><span class="token token">// Genera vecinos (cada vecino = 1 movimiento)</span><span>
</span></span><span><span></span><span class="token token">function</span><span></span><span class="token token">neighbors</span><span class="token token punctuation">(</span><span>state</span><span class="token token operator">:</span><span> State</span><span class="token token punctuation">,</span><span></span><span class="token token constant">CAP</span><span class="token token operator">:</span><span></span><span class="token token">number</span><span class="token token punctuation">)</span><span class="token token operator">:</span><span></span><span class="token token">Array</span><span class="token token operator"><</span><span class="token token punctuation">{</span><span> move</span><span class="token token operator">:</span><span> Move</span><span class="token token punctuation">;</span><span> next</span><span class="token token operator">:</span><span> State </span><span class="token token punctuation">}</span><span class="token token operator">></span><span></span><span class="token token punctuation">{</span><span>
</span></span><span><span></span><span class="token token">const</span><span> res</span><span class="token token operator">:</span><span></span><span class="token token">Array</span><span class="token token operator"><</span><span class="token token punctuation">{</span><span> move</span><span class="token token operator">:</span><span> Move</span><span class="token token punctuation">;</span><span> next</span><span class="token token operator">:</span><span> State </span><span class="token token punctuation">}</span><span class="token token operator">></span><span></span><span class="token token operator">=</span><span></span><span class="token token punctuation">[</span><span class="token token punctuation">]</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token">const</span><span> m </span><span class="token token operator">=</span><span> state</span><span class="token token punctuation">.</span><span>length</span><span class="token token punctuation">;</span><span>
</span></span><span>
</span><span><span></span><span class="token token">for</span><span></span><span class="token token punctuation">(</span><span class="token token">let</span><span> i </span><span class="token token operator">=</span><span></span><span class="token token">0</span><span class="token token punctuation">;</span><span> i </span><span class="token token operator"><</span><span> m</span><span class="token token punctuation">;</span><span> i</span><span class="token token operator">++</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span></span><span><span></span><span class="token token">for</span><span></span><span class="token token punctuation">(</span><span class="token token">let</span><span> j </span><span class="token token operator">=</span><span></span><span class="token token">0</span><span class="token token punctuation">;</span><span> j </span><span class="token token operator"><</span><span> m</span><span class="token token punctuation">;</span><span> j</span><span class="token token operator">++</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span></span><span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span>i </span><span class="token token operator">===</span><span> j</span><span class="token token punctuation">)</span><span></span><span class="token token">continue</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token">const</span><span> from </span><span class="token token operator">=</span><span> state</span><span class="token token punctuation">[</span><span>i</span><span class="token token punctuation">]</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token">const</span><span> to </span><span class="token token operator">=</span><span> state</span><span class="token token punctuation">[</span><span>j</span><span class="token token punctuation">]</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span class="token token operator">!</span><span class="token token">canPour</span><span class="token token punctuation">(</span><span>from</span><span class="token token punctuation">,</span><span> to</span><span class="token token punctuation">,</span><span></span><span class="token token constant">CAP</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span></span><span class="token token">continue</span><span class="token token punctuation">;</span><span>
</span></span><span>
</span><span><span></span><span class="token token">const</span><span> color </span><span class="token token operator">=</span><span></span><span class="token token">topColor</span><span class="token token punctuation">(</span><span>from</span><span class="token token punctuation">)</span><span class="token token operator">!</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token">const</span><span> amount </span><span class="token token operator">=</span><span> Math</span><span class="token token punctuation">.</span><span class="token token">min</span><span class="token token punctuation">(</span><span class="token token">topRunLength</span><span class="token token punctuation">(</span><span>from</span><span class="token token punctuation">)</span><span class="token token punctuation">,</span><span></span><span class="token token">freeSpace</span><span class="token token punctuation">(</span><span>to</span><span class="token token punctuation">,</span><span></span><span class="token token constant">CAP</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span>amount </span><span class="token token operator"><=</span><span></span><span class="token token">0</span><span class="token token punctuation">)</span><span></span><span class="token token">continue</span><span class="token token punctuation">;</span><span>
</span></span><span>
</span><span><span></span><span class="token token">// aplicar vertido (clonar mínimo necesario)</span><span>
</span></span><span><span></span><span class="token token">const</span><span> next</span><span class="token token operator">:</span><span> State </span><span class="token token operator">=</span><span> state</span><span class="token token punctuation">.</span><span class="token token">map</span><span class="token token punctuation">(</span><span>b </span><span class="token token operator">=></span><span> b</span><span class="token token punctuation">.</span><span class="token token">slice</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token">for</span><span></span><span class="token token punctuation">(</span><span class="token token">let</span><span> t </span><span class="token token operator">=</span><span></span><span class="token token">0</span><span class="token token punctuation">;</span><span> t </span><span class="token token operator"><</span><span> amount</span><span class="token token punctuation">;</span><span> t</span><span class="token token operator">++</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span></span><span><span>        next</span><span class="token token punctuation">[</span><span>j</span><span class="token token punctuation">]</span><span class="token token punctuation">.</span><span class="token token">push</span><span class="token token punctuation">(</span><span>next</span><span class="token token punctuation">[</span><span>i</span><span class="token token punctuation">]</span><span class="token token punctuation">.</span><span class="token token">pop</span><span class="token token punctuation">(</span><span class="token token punctuation">)</span><span class="token token operator">!</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token punctuation">}</span><span>
</span></span><span><span>      res</span><span class="token token punctuation">.</span><span class="token token">push</span><span class="token token punctuation">(</span><span class="token token punctuation">{</span><span> move</span><span class="token token operator">:</span><span></span><span class="token token punctuation">{</span><span> from</span><span class="token token operator">:</span><span> i</span><span class="token token punctuation">,</span><span> to</span><span class="token token operator">:</span><span> j</span><span class="token token punctuation">,</span><span> amount</span><span class="token token punctuation">,</span><span> color </span><span class="token token punctuation">}</span><span class="token token punctuation">,</span><span> next </span><span class="token token punctuation">}</span><span class="token token punctuation">)</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token punctuation">}</span><span>
</span></span><span><span></span><span class="token token punctuation">}</span><span>
</span></span><span><span></span><span class="token token">return</span><span> res</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token punctuation">}</span><span>
</span></span><span>
</span><span><span></span><span class="token token">function</span><span></span><span class="token token">isUniformOrEmpty</span><span class="token token punctuation">(</span><span>b</span><span class="token token operator">:</span><span> Bottle</span><span class="token token punctuation">)</span><span class="token token operator">:</span><span></span><span class="token token">boolean</span><span></span><span class="token token punctuation">{</span><span>
</span></span><span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span>b</span><span class="token token punctuation">.</span><span>length </span><span class="token token operator">===</span><span></span><span class="token token">0</span><span class="token token punctuation">)</span><span></span><span class="token token">return</span><span></span><span class="token token boolean">true</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token">const</span><span> c </span><span class="token token operator">=</span><span> b</span><span class="token token punctuation">[</span><span class="token token">0</span><span class="token token punctuation">]</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token">for</span><span></span><span class="token token punctuation">(</span><span class="token token">let</span><span> i </span><span class="token token operator">=</span><span></span><span class="token token">1</span><span class="token token punctuation">;</span><span> i </span><span class="token token operator"><</span><span> b</span><span class="token token punctuation">.</span><span>length</span><span class="token token punctuation">;</span><span> i</span><span class="token token operator">++</span><span class="token token punctuation">)</span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span>b</span><span class="token token punctuation">[</span><span>i</span><span class="token token punctuation">]</span><span></span><span class="token token operator">!==</span><span> c</span><span class="token token punctuation">)</span><span></span><span class="token token">return</span><span></span><span class="token token boolean">false</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token">return</span><span></span><span class="token token boolean">true</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token punctuation">}</span><span>
</span></span><span>
</span><span><span></span><span class="token token">function</span><span></span><span class="token token">isSolved</span><span class="token token punctuation">(</span><span>state</span><span class="token token operator">:</span><span> State</span><span class="token token punctuation">,</span><span></span><span class="token token constant">CAP</span><span class="token token operator">:</span><span></span><span class="token token">number</span><span class="token token punctuation">)</span><span class="token token operator">:</span><span></span><span class="token token">boolean</span><span></span><span class="token token punctuation">{</span><span>
</span></span><span><span></span><span class="token token">// típico: vacío o completo y uniforme</span><span>
</span></span><span><span></span><span class="token token">for</span><span></span><span class="token token punctuation">(</span><span class="token token">const</span><span> b </span><span class="token token">of</span><span> state</span><span class="token token punctuation">)</span><span></span><span class="token token punctuation">{</span><span>
</span></span><span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span>b</span><span class="token token punctuation">.</span><span>length </span><span class="token token operator">===</span><span></span><span class="token token">0</span><span class="token token punctuation">)</span><span></span><span class="token token">continue</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span>b</span><span class="token token punctuation">.</span><span>length </span><span class="token token operator">!==</span><span></span><span class="token token constant">CAP</span><span class="token token punctuation">)</span><span></span><span class="token token">return</span><span></span><span class="token token boolean">false</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token">if</span><span></span><span class="token token punctuation">(</span><span class="token token operator">!</span><span class="token token">isUniformOrEmpty</span><span class="token token punctuation">(</span><span>b</span><span class="token token punctuation">)</span><span class="token token punctuation">)</span><span></span><span class="token token">return</span><span></span><span class="token token boolean">false</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token punctuation">}</span><span>
</span></span><span><span></span><span class="token token">return</span><span></span><span class="token token boolean">true</span><span class="token token punctuation">;</span><span>
</span></span><span><span></span><span class="token token punctuation">}</span><span>
</span></span><span></span></code></span></div></div></div></pre>

---

## Heurística recomendada (segura para “óptimo real”)

Para garantizar optimalidad con A*, `h(state)` debe ser admisible. Una opción fácil y usual en Water Sort es contar “rupturas de color” dentro de cada botella (cuando dos segmentos consecutivos son de distinto color); esa idea aparece en implementaciones de A* para este puzzle.

Ejemplo (conservador):

* `breaks = sum over bottles of number of adjacent color changes`
* `h = ceil(breaks / CAP)` o incluso `h = 0` si quieres 100% seguro pero menos guiado.

Nota: mientras más agresiva la heurística, más rápido, pero si llega a sobreestimar pierdes la garantía de óptimo.

---

## Resultado: “movimientos óptimos”

* Ejecuta BFS/A* hasta encontrar `isSolved(state)`.
* La longitud del path (número de vertidos) es el  **mínimo de movimientos** , según tu definición 1 vertido = 1 movimiento.

---

Si me dices tu tamaño objetivo (por ejemplo N≤36**N**≤**36**, CAP=6, E=2..6) y si lo quieres **en runtime (móvil)** o solo  **offline (generación de niveles)** , ajusto la recomendación (p. ej. A* con poda, IDA*, hashing/canonicalización de simetrías, límites de expansión).
